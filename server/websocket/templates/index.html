<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Ouster Viewer</title>
	<body>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
		<script type="text/javascript" charset="utf-8">
			var socket = io();

			window.onload = function() {
				var canvas = document.getElementById("lidar_scan");
				// canvas.width = window.innerWidth;
				// canvas.height = window.innerHeight;

				var gl = canvas.getContext("webgl");
				gl.clearColor(0.0, 0.0, 0.0, 1.0);
				gl.enable(gl.DEPTH_TEST);
				gl.viewport(0, 0, canvas.width, canvas.height);

				var vertex_buffer = gl.createBuffer();

				var vertCode = `
					attribute vec3 coordinates;
					void main(void) {
						gl_Position = vec4(0.1 * coordinates, 1.0);
						gl_PointSize = 1.0;
					}
				`;
				var vertShader = gl.createShader(gl.VERTEX_SHADER);
				gl.shaderSource(vertShader, vertCode);
				gl.compileShader(vertShader);

				var fragCode = `
					void main(void) {
						gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
					}
				`;
				var fragShader = gl.createShader(gl.FRAGMENT_SHADER);
				gl.shaderSource(fragShader, fragCode);
				gl.compileShader(fragShader);

				var shaderProgram = gl.createProgram();
				gl.attachShader(shaderProgram, vertShader);
				gl.attachShader(shaderProgram, fragShader);
				gl.linkProgram(shaderProgram);
				gl.useProgram(shaderProgram);

				gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);
				var coord = gl.getAttribLocation(shaderProgram, "coordinates");
				gl.vertexAttribPointer(coord, 3, gl.FLOAT, false, 0, 0);
				gl.enableVertexAttribArray(coord);
				
				socket.on("lidar_scan", function(data) {
					console.log("%d points received", data.length / 3);
					
					var vertices = new Float32Array(data);
					gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);
					gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

					gl.clear(gl.COLOR_BUFFER_BIT);
					gl.drawArrays(gl.POINTS, 0, vertices.length / 3);
				});
			};
		</script>
		<canvas id="lidar_scan" width="500" height="500"></canvas>
	</body>
</html>
